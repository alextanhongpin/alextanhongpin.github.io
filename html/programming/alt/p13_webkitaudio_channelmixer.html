<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../css/grid_layout.css">
    <script src='http://code.jquery.com/jquery-2.1.1.js'></script>
<style>
   

    
    *{
        margin: 0;
        padding: 0;
    }
    
    body{
        -moz-user-select: none; 
        -webkit-user-select: none; 
        -ms-user-select:none;
        cursor: pointer;
        user-select:none;
        background: #fff;
        width: 100%;
        height: 100%;
        display: block;
        text-align: center;
        font-family: Tahoma;
    }
    
    #canvas{
        display: block;
    }
    
  
</style>
      
    <title>@alextanhongpin</title>
      
  </head>
  <body>
      <canvas id="canvas" width="300" height="200"></canvas>
      <audio id="player"></audio>
   </body>
    
  <script>$(document).ready(function(){
    
    'use strict';
    
    var canvas = document.getElementById('canvas');
        canvas.height = window.innerHeight;
        canvas.width  = window.innerWidth;
    var ctx = canvas.getContext('2d');
    
    if (! window.AudioContext){
        if(! window.webkitAudioContext){
            alert('no audiocontext found');
        }
        window.AudioContext = window.webkitAudioContext;
    }
    var context = new AudioContext();
    var audioBuffer;
    var sourceNode;

    //load the sound
    setupAudioNodes();
    loadSound('/audio/GMS%20Juice%20-%20Requiem%20of%20a%20Dream.mp3');
    
    function setupAudioNodes(){
        sourceNode = context.createBufferSource();
        sourceNode.connect(context.destination);
    }
    
    function loadSound(url){
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';
        request.onload = function(){
            context.decodeAudioData(request.response, function(buffer){
                playSound(buffer);
            }, onError);
        }
        request.send();
    }
    
    function playSound(buffer){
        sourceNode.buffer = buffer;
        sourceNode.start(0);
        //sourceNode.noteOn(0);
    }

    function onError(e){
        console.log(e);
    }
    
    var javascriptNode;
    var analyser, analyser2, splitter;
    function setupAudioNodes(){
        javascriptNode = context.createScriptProcessor(2048, 1, 1);
        javascriptNode.connect(context.destination);
        
        analyser = context.createAnalyser();
        analyser.smoothingTimeConstant = 0.3;
        analyser.fftSize = 1024;
        
        analyser2 = context.createAnalyser();
        analyser2.smoothingTimeConstant = 0.0;
        analyser2.fftSize = 1024;
        
        sourceNode = context.createBufferSource();
        splitter = context.createChannelSplitter();
        
        sourceNode.connect(splitter);
        splitter.connect(analyser, 0, 0);
        splitter.connect(analyser2, 1, 0);
        
        analyser.connect(javascriptNode);
        sourceNode.connect(context.destination);
    }
    
  
    javascriptNode.onaudioprocess = function(){
        var array = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(array);
        var average = getAverageVolume(array);
        
        var array2 = new Uint8Array(analyser2.frequencyBinCount);
        analyser2.getByteFrequencyData(array2);
        var average2 = getAverageVolume(array2);
        
        ctx.clearRect(0,0,60,130);
        var gradient = ctx.createLinearGradient(0,0,0,130);
            gradient.addColorStop(0,'#f22');
            gradient.addColorStop(0.4,'#ff2');
            gradient.addColorStop(0.8,'#fff');
            gradient.addColorStop(1.0,'#2ff');

        ctx.fillStyle = gradient;
        ctx.fillRect(0,130-average,25,130);
        ctx.fillRect(30,130-average,25,130);
        
    }
    function getAverageVolume(array){
        var values = 0;
        var average;
        var length = array.length;
        
        for (var i = 0; i < length; i++){
            values += array[i];
        }
        average = values / length;
        return average;
    }
 
    
    

});</script>
</html>